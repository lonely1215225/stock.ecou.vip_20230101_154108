/**
 * TinySelect 0.4.2 2018-05-24
 * @作者: hyjiacan
 * @源码: https://gitee.com/hyjiacan/TinySelect.git
 * @示例: http://hyjiacan.oschina.io/tinyselect
 * @许可协议: MIT
 * @依赖: jQuery 1.8.0及更高版本
 * @浏览器支持: 不支持IE8及更低版本
 * @QQ群: 187786345 (Javascript爱好者)
 */

!function(a,b){"use strict";function c(a){this.selector=[],this.css(a)}function d(a,c,e){var f=b(a).get(0);if(f){for(var g,h=0;h<aa.length;h++)if(g=aa[h],g.source.get(0)===f)return g;return g=new d.fn.init(f,c,e),aa.push(g),g}}function e(a,c){var d=b("<div>"),e=a.option,f=e.result,g=c.get(0);if(Object.defineProperty(a,"fromSelect",{writabke:ga,configurable:ga,value:fa}),!f||!f.style&&!f.css){var h=c.height();b.each(["padding","margin","box-sizing","color","background","background-color","font","border","lineHeight","top","right","bottom","left"],function(a,b){d.css(b,c.css(b))});var i=V(c,"position"),j=W(c);d.css({position:/^static$/.test(i)?"relative":i,width:c.width(),height:h,lineHeight:h-j.top-j.bottom+"px"})}f.multi=g.hasAttribute("multiple");var k=[],l=[],m=ga;return c.find("option").each(function(){var a=b(this),c=a.parent(),d=a.val(),e={id:d,text:a.text()};c.is("optgroup")&&(m=fa,e.group=c.attr("label")),k.push(e),a.is(":selected")&&l.push(d)}),m&&(e.group.valueField="group"),e.item.data=k,l.length&&(e.item.value=l),(g.hasAttribute("readonly")||c.is(":disabled"))&&(e.readonly=fa),c.hide(),c.after(d),d}function f(a){var c=a.option,d=a.context,e=c.result,f=ea(c.tabindex);if(f=c.tabindex=isNaN(f)||f<0?ga:f,f!==ga&&d.attr("tabindex",f),d.addClass(ja),c.readonly&&d.addClass(oa),e.css&&d.addClass(e.css),e.style&&d.css(e.style),e.render&&e.render.call(d),c.mode===$a)return void(a.result=b());d.append(a.placeholder=hb(la).html(c.result.placeholder)),d.append(a.result=hb(ma));var g=e.arrow;g===ga||g===ha&&e.multi||(d.addClass(ka).append(hb(na)),/static/i.test(V(d,"position"))&&d.css("position","relative"))}function g(a){var c=a.option,d=a.context,e=a.dom=hb(pa).addClass("{0}-mode-{0}".fill(ia,c.mode)),f=c.tabindex;switch(f!==ga&&e.attr("tabindex",f),c.mode){case $a:c.style.width=d.siblings(":visible").length?d.width():"auto",c.style.height=d.height()||"auto";var g=V(d,"position");c.style.position=/static/i.test(g)?"relative":g,d.append(e);break;case Za:b(ba.body).append(e);break;case _a:b(ba.body).append((a.mask=hb(qa)).append(e))}e.addClass(c.css).css(c.style).append(h(a,c));var i=c.box,k=a.box=hb(Aa).addClass("{0}-layout-{0}".fill(Aa,i.layout)).addClass(i.css).css(i.style);i.layout===bb&&k.append(hb(ra)),e.append(k),e.append(j(a,c))}function h(a,b){var c=b.header,d=a.header=hb(ua).addClass(c.css).css(c.style).append(i(a,b));return c.render&&c.render.call(d,b.item.data),d}function i(c,d){var e=d.header.filter,f=b('<input type="text"  placeholder="{0}" class="{0}" />'.fill(e.placeholder,Ia)).addClass(e.css).css(e.style);return f.keyup(function(d){var g=f.val();$&&(a.clearTimeout($),$=0),(/^change$/i.test(e.trigger)?""===b.trim(String.fromCharCode(d.keyCode||d.which))||f.data("last")!==g:13===d.keyCode)&&(f.data("last",g),$=da(function(){c.filter(g,fa)},e.delay))}),f}function j(a,b){var c=b.footer,d=a.footer=hb(va).addClass(c.css).css(c.style),e=hb(wa),f=hb(xa);return f.append(hb(ya,Xa).html(c.totalTpl.replace(Va,0))),d.append(e).append(f),b.result.multi&&k(a,b,e,f),c.render&&c.render.call(d,b.data),d}function k(a,c,d,e){var f=b(Ya);d.append(b("<label>").append(f).append("全选")),f.change(function(){var c=f.is(":checked");N(a,Wa).each(function(d,e){if(e=b(e),c){if(e.hasClass(Ga))return;return void H(a,e,fa)}e.hasClass(Ga)&&I(a,e,fa)})});var g=hb(za,Xa);P(c,g),e.prepend(g)}function l(a,c){var d=c.valueField,e=c.valueField,f=c.textField||e,g=[{isGroup:fa,text:c.unknown,id:0}],h={},i=0,j=[];if(b.each(a,function(a,b){var c={data:b,index:a,group:""};if(!d)return void j.push(c);var k=eb(b,e),l=eb(b,f);if(!k)return b.group=0,void g.push(c);var m=b[e],n=l?b[f]:"";eb(h,m)||(h[m]={id:++i,text:n,data:[]}),c.group=i,h[m].data.push(c)}),!d)return j;var k=[];return b.each(h,function(a,b){k.push({id:b.id,isGroup:fa,key:a,text:b.text}),ib(k,b.data)}),g.length>1&&ib(k,g),k}function m(a,b){var d=a.box,e=a.option,f=e.item,g=f.data,h=e.group,i=ea(f.visible);(isNaN(i)||i<0)&&(i=0);var j=g?g.length:0;d.height("auto"),e.box.layout===bb?d.find(c.build(ra).first()).empty():d.empty(),a.fromSelect&&a.source.empty(),F(a),a.dom.removeClass(ta);var k=L(a);if(S(k,j),O(e,k),!j)return d.append(e.box.empty),a.dom.addClass(ta),void(b&&b.call(a,g));g=l(g,h),j=g.length;var m=n(a,d,f,g,b,0,i);if(isNaN(ea(a.dom.get(0).style.height))){if(0===i||i>=j)return;Y(a);var o=U(m).height;Z(a);var p=0;if(h.valueField){var q=d.find(c.build(Ba));p=q.first().height()*q.length}d.height(i*o+p)}else{var r=a.dom.height();if(a.header.is(Wa)&&(r-=U(a.header).height),a.footer.is(Wa)&&(r-=U(a.footer).height),d.height(r),0===i||i>=j)return}f.async?fb(n,[a,d,f,g,b,i]):n(a,d,f,g,b,0)}function n(a,b,d,e,f,g,h){var i,j=a.option.box.layout===bb;j&&(b=b.find(c.build(ra).first()));var k=a.fromSelect,l=a.source,m=a.option.group,n=d.data;if(h=h||e.length-g,!(g>=e.length)){var p=g+h;p>e.length&&(p=e.length);for(var q,r=m.valueField,s=g;s<p;s++){var t=e[s];if(r&&t.isGroup){var u=hb(Ba).addClass(m.css).css(m.style).html(t.text).attr(Ua,t.id);m.render&&u.append(m.render.call(a,u,t)),b.append(u),q=ha,k&&l.append(hb("","optgroup").text(t.text).attr("value",t.id))}else{var v=c.build(sa);q=b.find((r?v.attr(Ua,t.group):v).done()),q&&q.length||(q=hb(sa).attr(Ua,t.group),b.append(q));var w=t.index;t=t.data;var x=S(hb(Ca),t);if(q.append(x),x.addClass(d.css).css(d.style),j)o(a,t,x,w);else{var y=hb(Da),z=hb(Ea),A=hb(Fa);x.append(y).append(z).append(A),z.append(d.render?d.render.call(x,t,w,n):t[d.textField])}x.attr(Ta,s),r&&x.attr(Ua,t.group),i||(i=x),k&&l.append(hb("","option").text(t.text).attr("value",t.id))}}return p!==e.length?i:(f.call(a,n),i)}}function o(a,c,d,e){var f=a.option.box.columns;_||(p(f),_=fa),b.each(f,function(b,f){var g=hb(Ma),h=c[f.field];switch(h=void 0===h||null===h?"":h,f.type){case"index":h=e;break;case"status":g.addClass(Fa)}f.style&&g.css(f.style),f.css&&g.addClass(f.css),f.align&&g.css("text-align",f.align),f.width&&g.css("width",f.width),f.render&&(h=f.render.call(a,{rowIndex:e,columnIndex:b,data:c,value:h})),g.append(h),d.append(g)})}function p(a){if(a.every(function(a,b){return b.width})){var c=100/a.length;b.each(a,function(b){a[b].width="{0}%".fill(100*c)})}}function q(c){c.option.mode!==$a&&(r(c),u(c)),v(c),c.option.keyboard&&w(c),b(a).resize(function(){c.dom.is(Wa)&&(s(c.context,c.dom,c.option),t(c))})}function r(a){a.context.on("click focus",function(){a.option.readonly||a.dom.is(Wa)||a.show()})}function s(c,d,e){var f=c.offset(),g=e.mode,h=d.height(),i=b(a).height(),j=U(c),k=j.height,l=j.width;g===Za?(i-f.top-k<h?f.top=f.top-h-2:f.top=f.top+k+2,d.css({left:f.left,top:f.top,width:e.style.width||l})):g===_a&&d.parent().css({paddingTop:(i-h)/3,paddingLeft:(b(a).width()-d.width())/2})}function t(a){var b=a.dom;if("100%"!==b.get(0).style.height){var c=b.parent().height();if(c>0&&(a.option.mode===$a||b.height()>=c)){var d=X(b);b.height(c-d.top-d.bottom)}}var e=b.get(0).style.height;e&&!/auto/i.test(e)&&a.box.height(b.height()-8-(a.header.is(Wa)?a.header.height():0)-(a.footer.is(Wa)?a.footer.height():0))}function u(c){var d=c.context,e=c.dom;b(a).mousedown(function(a){var b=a.target;d.is(b)||e.is(b)||d.find(b).length||e.find(b).length||e.is(Wa)&&c.hide()})}function v(a){a.box.on("click",c.build(Ca).done(),function(){var c=b(this);G(a,c,fa,fa),a.fromSelect&&a.option.result.sync&&a.source.val(a.value()),a.option.result.multi||a.hide()})}function w(d){b(a).keydown(function(a){if(d.dom.is(Wa)){var b,e=d.box.find(c.build(Ha).first());switch(a.keyCode||a.which){case 40:b=y(d,e);break;case 38:b=x(d,e);break;case 32:case 13:return void e.click();case 27:return void d.hide();default:return}b.length||(b=e),d.header.find("."+Ia).blur(),b.focus(),e.removeClass(Ha),b.addClass(Ha),z(b)}}),d.dom.on("mouseover",c.build(Ca).done(),function(){d.box.find("."+Ha).removeClass(Ha),b(this).addClass(Ha)})}function x(a,b){if(0===b.length)return N(a).eq(0);var d=b.prev();return d.length||(d=b.parent().prevAll(c.build(sa).first()).find(c.build(Ca).last())),d}function y(a,b){if(0===b.length)return N(a).eq(0);var d=b.next();return d.length||(d=b.parent().nextAll(c.build(sa).first()).find(c.build(Ca).first())),d}function z(a){var b=a.parent().parent();/auto/i.test(V(b,"overflowY"))||(b=b.parent()),b.stop().animate({scrollTop:a.offset().top-b.offset().top+b.scrollTop()-U(a).height},100)}function A(a,b,d){var e=a.option,f=e.result.item;if(e.mode!==$a){var g=hb(Ja).attr(Ta,d).append(hb(Ka,Xa).html(b)).append(hb(La,Xa).click(function(){if(!e.readonly)return I(a,N(a,c.build().attr(Ta,d).first()),fa),ga}));return f.css&&g.addClass(f.css),f.style&&g.css(f.style),g}}function B(a,b,c){return C(a,b,{target:c.get(0),data:R(c),index:c.attr(Ta)})}function C(a,b,c){if(eb(a.events,b)){c.type=b;for(var d=a.events[b],e=d.length-1;e>=0;e--)if(d[e].call(a,c)===ga)return ga}}function D(a){var d=a.option,e=d.item.valueField;if(!d.result.multi){var f=N(a,c.build(Ga).first());return 0===f.length?void 0:R(f)[e]}return b.makeArray(N(a,c.build(Ga).done()).map(function(a,c){return R(b(c))[e]}))}function E(a,c,d){for(var e,f=a.option,g=f.result.multi,h=b.makeArray(c),i=0,j=N(a);i<j.length;i++){e=b(j[i]);if(-1!==h.indexOf(R(e)[f.item.valueField])){if(G(a,e,ga,d),!g)return}else g&&I(a,e,d)}}function F(a){var d=N(a);if(a.result.empty(),a.option.result.multi)return void d.filter(c.build(Ga).done()).each(function(c,d){I(a,b(d),fa)});var e=d.filter(c.build(Ga).first());e.length&&I(a,e,fa)}function G(a,b,d,e){var f=a.option.result.multi,g=b.hasClass(Ga);if(!f){if(g)return;var h=a.box.find(c.build(Ga).done()).not(b).first();return h.length&&I(a,h,e),void H(a,b,e)}if(!g)return void H(a,b,e);d&&I(a,b,e)}function H(a,b,c){c&&B(a,Na,b)===ga||(b.addClass(Ga),a.option.mode!==$a&&a.placeholder.hide(),J(a,R(b),b.attr(Ta)))}function I(a,b,c){var d=a.option;c&&B(a,Oa,b)===ga||(b.removeClass(Ga),d.mode!==$a&&(d.result.multi?0===a.value().length:void 0===a.value())&&a.placeholder.show(),K(a,b.attr(Ta)))}function J(a,b,c){var d=a.result,e=M(a),f=a.option,g=f.result,h=g.multi,i=g.item.render,j=b[f.item.textField];if(j=i?i.call(a,b):j,a.fromSelect&&a.source.val(a.value()),!h)return void d.text(j);if(f.mode!==$a){var k=A(a,j,c);d.append(k),d.stop().animate({scrollTop:d[0].scrollHeight})}S(e,(R(e)||0)+1),P(f,e)}function K(a,b){var d=a.option,e=d.result.multi;if(a.fromSelect&&a.source.val(a.value()),e){var f=M(a);a.result.find(c.build(Ja).attr(Ta,b).first()).remove();var g=R(f);S(f,g>0?g-1:0),P(d,f)}}function L(a){return a.footer.find(c.build(xa).sub(ya).done())}function M(a){return a.footer.find(c.build(xa).sub(za).done())}function N(a,b){return a.box.find(c.build(Ca).addon(b).done())}function O(a,b){Q(b,a.footer.totalTpl)}function P(a,b){Q(b,a.footer.selectedTpl)}function Q(a,b){a.html(b.replace(Va,R(a)||0))}function R(a,b){return a.data(b||Qa)}function S(a,b,c){return a.data(c||Qa,b)}function T(a,b,d){var e=a.filter(c.build().attr(Ua,d).done());0===b.filter(c.build().attr(Ua,d).visible()).length?e.hide():e.show()}function U(a){var b=a.width(),c=a.height(),d=W(a);return/^border-box$/i.test(V(a,"box-sizing"))&&(c+=d.top+d.bottom+ea(V(a,"border-top-width"))+ea(V(a,"border-bottom-width")),b+=d.left+d.right+ea(V(a,"border-left-width"))+ea(V(a,"border-right-width"))),{width:b,height:c}}function V(a,b){return a.css(b)}function W(a){return{top:ea(V(a,"padding-top"))||0,right:ea(V(a,"padding-right"))||0,bottom:ea(V(a,"padding-bottom"))||0,left:ea(V(a,"padding-left"))||0}}function X(a){return{top:ea(V(a,"border-top"))||0,right:ea(V(a,"border-right"))||0,bottom:ea(V(a,"border-bottom"))||0,left:ea(V(a,"border-left"))||0}}function Y(a){S(a.dom,V(a.dom,Ra),Ra),a.dom.css({display:"block",visibility:"hidden"})}function Z(a){a.dom.css({display:R(a.dom,Ra)||"none",visibility:Sa})}String.prototype.fill=function(){var a=[].slice.apply(arguments);return this.replace(/{([0-9]+)(\/.[lLrR]?)?}/g,function(b,c,d){var e=a.length?a.shift():"";if(e=null===e||void 0===e?"":String(e).toString(),0===c)return e;var f=c-e.length;if(f<=0)return e;for(var g=d[1],h=d[2]||"l",i="",j=0;j<f;j++)i+=g;return/r/i.test(h)?e+=i:e=i+e,e})};var $,_,aa=[],ba=a.document,ca=a.console,da=a.setTimeout,ea=a.parseInt,fa=!0,ga=!1,ha=null,ia="tinyselect",ja=ia+"-context",ka=ja+"-with-arrow",la=ja+"-placeholder",ma=ja+"-result",na=ja+"-arrow",oa=ja+"-readonly",pa=ia+"-container",qa=ia+"-mask",ra=ia+"-scroll-proxy",sa=ia+"-group-content",ta=pa+"-empty",ua=ia+"-header",va=ia+"-footer",wa=va+"-left",xa=va+"-right",ya=ia+"-count-total",za=ia+"-count-selected",Aa=ia+"-box",Ba=ia+"-group",Ca=ia+"-item",Da=ia+"-item-before",Ea=ia+"-item-text",Fa=ia+"-item-after",Ga=Ca+"-selected",Ha=Ca+"-hover",Ia=ia+"-filter",Ja=ia+"-result-item",Ka=Ja+"-text",La=Ja+"-link",Ma=Ca+"-table-col",Na="select",Oa="unselect",Pa=[Na,Oa],Qa="data",Ra="display",Sa="visible",Ta="data-tiny-index",Ua="data-tiny-group",Va="%s",Wa=":"+Sa,Xa="span",Ya='<input type="checkbox" style="vertical-align:-2px;" class="{0}-selectall" />'.fill(ia),Za="dropdown",$a="list",_a="popup",ab=[Za,$a,_a],bb="table",cb=["list","grid",bb],db={ready:ha,readonly:ga,mode:Za,keyboard:fa,tabindex:0,css:ha,style:{lineHeight:"28px"},header:{render:ga,filter:{trigger:"enter",delay:618,placeholder:"输入后按回车过滤",matchCase:ga,css:ha,style:{}},css:ha,style:{}},box:{empty:"没有数据",layout:"list",css:ha,style:{},columns:ha},group:{valueField:ga,textField:ga,unknown:"未分组",render:ga,css:ha,style:{}},item:{data:[],value:ga,valueField:"id",textField:"text",visible:5,render:ga,async:fa,css:ha,style:{}},footer:{render:ga,totalTpl:"共{0}项".fill(Va),selectedTpl:"选中{0}项/".fill(Va),css:ha,style:{}},result:{placeholder:"请选择",clear:fa,multi:ga,arrow:ha,sync:fa,render:ga,type:0,css:null,style:{},item:{render:ga,style:ha,css:ha}}};c.prototype={constructor:c,css:function(a){return a&&this.selector.push("."+a),this},attr:function(a,b){return 1===arguments.length?this.selector.push("[{0}]".fill(a)):this.selector.push("[{0}={0}]".fill(a,b)),this},sub:function(a){return this.selector.push(" "),this.css(a)},visible:function(){return this.addon(Wa).done()},first:function(){return this.addon(":first").done()},last:function(){return this.addon(":last").done()},addon:function(a){return a&&this.selector.push(a),this},done:function(a){return this.css(a),this.selector.join("")}},c.build=function(a){return new c(a)};var eb=function(a,b){return!a||a.hasOwnProperty(b)},fb=function(a,b){da(function(){a.apply(ha,b)},0)},gb=function(a,c){return b.extend(fa,b.isArray(a)?[]:{},a,c)},hb=function(a,c){return b('<{0} class="{0}">'.fill(c||"div",a))},ib=function(a,b){Array.prototype.push.apply(a,b)};d.fn=d.prototype={constructor:d,init:function(a,c,d){var h=this;if(h.ready=ga,b.isArray(c))h.option=gb(db,{item:{data:c},result:{multi:d}});else{h.option=gb(db,c);var i=h.option.mode||Za;if(-1===ab.indexOf(i))throw new Error('Render mode "{0}" is not supported,\nhere is the valid modes: {0}'.fill(i,ab.join()));var j=h.option.box.layout||"list";if(-1===cb.indexOf(j))throw new Error('Layout "{0}" is not supported,\nhere is the valid modes: {0}'.fill(j,cb.join()));if(j===bb&&!h.option.box.columns)throw new Error('You specified table-layout, but you have not set option "box.columns"')}return c=h.option,h.source=a=b(a),h.context=a.is("select")?e(h,a):a,f(h),h.events={},g(h),q(h),h.load(c.item.data,function(){h.ready=fa,c.ready&&c.ready.call(h)}),h},on:function(a,b){var c=this;if(-1===Pa.indexOf(a))return ca.warn("{0}:{0}".fill("不支持此事件类型",a)),c;var d=c.events;return eb(d,a)?d[a].push(b):d[a]=[b],c},off:function(a,b){var c=this;if(-1===Pa.indexOf(a))return c;var d=c.events;if(!eb(d,a))return c;var e=d[a],f=e.indexOf(b);return-1!==f&&e.splice(f,1),c},show:function(a){var b=this,d=b.dom,e=b.option.mode;return e===$a?b:(e===_a&&b.mask.show(),s(b.context,d,b.option),d.fadeIn("fast",function(){d.find(c.build(ua).sub(Ia).visible()).focus(),t(b),a&&a.call(b)}),b)},hide:function(a){var b=this,c=b.option.mode;return c===$a?b:((c===Za?b.dom:b.mask).fadeOut("fast",function(){a&&a.call(b)}),b)},filter:function(a,d){function e(a){if(i){var c=b(a).attr(Ua),d=l[c];++d.handled<d.total||T(k,j,c)}}var f=this,g=[],h=b.isFunction(a),i=f.option.group.valueField,j=N(f),k=f.dom.find(c.build(Ba).done()),l={};return k.each(function(){var a=b(this).attr(Ua);l[a]={total:j.filter(c.build(Ca).attr(Ua,a).done()).length,handled:0}}),j.each(function(c,i){i=b(i);var j=R(i);(h?a.call(this,j):f.option.header.filter.matchCase?-1!==i.text().indexOf(a.toString()):-1!==i.text().toLowerCase().indexOf(a.toString().toLowerCase()))?(g.push({item:i,data:j}),d&&i.slideDown(50,function(){e(this)})):d&&i.slideUp(50,function(){e(this)})}),g},value:function(a,b){var c=this;return 0===arguments.length?D(c):(E(c,a,b),c)},clear:function(){return F(this),this},load:function(a,b){var c=this,d=c.option.item;return d.data=gb(a),m(c,function(){d.value&&c.value(d.value),t(c),b&&b.call(c,c.option.item.data)}),c},readonly:function(a){var b=this;return 0===arguments.length?b.option.readonly:(a?(b.hide(),b.context.addClass(oa)):b.context.removeClass(oa),b.option.readonly=a,b)}},d.fn.init.prototype=d.fn,d.defaults=db,a.tinyselect=d}(window,jQuery);