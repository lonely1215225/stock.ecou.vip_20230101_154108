<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>管理后台</title>
    <!-- Bootstrap 3.3.7 -->
    <link rel="stylesheet" href="__ADMIN_LTE__/components/bootstrap/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="__ADMIN_LTE__/components/font-awesome/css/font-awesome.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="__ADMIN_LTE__/components/Ionicons/css/ionicons.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="__ADMIN_LTE__/dist/css/AdminLTE.min.css">
    <!-- AdminLTE Skins. Choose a skin from the css/skins folder instead of downloading all of them to reduce the load. -->
    <link rel="stylesheet" href="__ADMIN_LTE__/dist/css/skins/_all-skins.min.css">
    <!--自定义样式-->
    <link rel="stylesheet" href="__DASH__/css/app.css">
    <!-- bootstrap wysihtml5 - text editor -->
    <!--<link rel="stylesheet" href="plugins/bootstrap-wysihtml5/bootstrap3-wysihtml5.min.css">-->
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="http://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
    <script src="http://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- jQuery 3 -->
    <script src="__DASH__/lib/jquery-3.3.1.min.js"></script>
    <!-- Layer -->
    <script src="__DASH__/lib/layer/layer.js"></script>
    <script type="text/javascript" src="__DASH__/lib/notify/js/jquery.notify.js"></script>
    <link rel="stylesheet" type="text/css" href="__DASH__/lib/notify/css/jquery.notify.css">
    <script src="__DASH__/lib/sockjs.min.js"></script>
</head>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">
    <header class="main-header">
        <!-- Logo -->
        <a href="index.html" class="logo">
            <!-- mini logo for sidebar mini 50x50 pixels -->
            <span class="logo-mini"><b>A</b>LT</span>
            <!-- logo for regular state and mobile devices -->
            <span class="logo-lg">管理后台</span>
        </a>
        <!-- Header Navbar: style can be found in header.less -->
        <nav class="navbar navbar-static-top">
            <!-- Sidebar toggle button-->
            <a href="#" class="sidebar-toggle" data-toggle="push-menu" role="button">
                <span class="sr-only">Toggle navigation</span>
            </a>
            <div class="navbar-custom-menu">
                <ul class="nav navbar-nav">
                    <li>
                        <a href="javascript:" class="dropdown-toggle" data-toggle="dropdown">
                            <i class="fa fa-user"></i>
                            <span class="hidden-xs">{$Think.session.username}</span>
                        </a>
                    </li>
                    <li>
                        <a href="javascript:signOut();"><i class="fa fa-power-off"></i></a>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- 左侧菜单  -->
    <aside class="main-sidebar">
        <section class="sidebar">
            <ul class="sidebar-menu" data-widget="tree">
                <li class="{$controller=='Index'?'active':''}">
                    <a href="{:url('index/index')}" class="{$action=='index'?'active':''}"><i class="fa fa-home"></i> <span>系统首页</span></a>
                </li>

				<li class="treeview {$controller=='Slide'?'active':''}">
                    <a href="#">
                        <i class="fa fa-edit"></i> <span>幻灯片管理</span>
                        <span class="pull-right-container">
                            <i class="fa fa-angle-left pull-right"></i>
                        </span>
                    </a>
                    <ul class="treeview-menu">
                        <li class="{$action=='index'?'active':''}"><a href="{:url('Slide/index')}"><i class="fa fa-circle-o"></i> 幻灯片管理</a></li>
                    </ul>
                </li>
				
                <li class="treeview {$controller=='News'?'active':''}">
                    <a href="#">
                        <i class="fa fa-edit"></i> <span>内容管理</span>
                        <span class="pull-right-container">
                            <i class="fa fa-angle-left pull-right"></i>
                        </span>
                    </a>
                    <ul class="treeview-menu">
                        <li class="{$action=='cat_list'?'active':''}"><a href="{:url('news/cat_list')}"><i class="fa fa-circle-o"></i> 栏目管理</a></li>
                        <li class="{$action=='index'?'active':''}"><a href="{:url('news/index')}"><i class="fa fa-circle-o"></i> 文章管理</a></li>
                        <li class="{$action=='contact'?'active':''}"><a href="{:url('news/contact')}"><i class="fa fa-circle-o"></i> 联系方式</a></li>
                    </ul>
                </li>

                <li class="treeview {$controller=='Notice'?'active':''}">
                    <a href="#">
                        <i class="fa fa-edit"></i> <span>公告管理</span>
                        <span class="pull-right-container">
                            <i class="fa fa-angle-left pull-right"></i>
                        </span>
                    </a>
                    <ul class="treeview-menu">
                        <li class="{$action=='notice_list'?'active':''}"><a href="{:url('notice/index')}"><i class="fa fa-circle-o"></i> 公告列表</a></li>
                    </ul>
                </li>

                <li class="treeview {$controller=='Risk'?'active':''}">
                    <a href="#">
                        <i class="fa fa-flash"></i> <span>股票管理</span>
                        <span class="pull-right-container">
                            <i class="fa fa-angle-left pull-right"></i>
                        </span>
                    </a>
                    <ul class="treeview-menu">
                        <li class="{$action=='index'?'active':''}"><a href="{:url('risk/index')}"><i class="fa fa-circle-o"></i> 个股管理</a></li>
                        <li class="{$action=='black_list'?'active':''}"><a href="{:url('risk/black_list')}"><i class="fa fa-circle-o"></i> 禁买列表</a></li>
                        <li class="{$action=='xrxd'?'active':''}"><a href="{:url('risk/xrxd')}"><i class="fa fa-circle-o"></i> 除权除息列表</a></li>
                        <li class="{$action=='suspension'?'active':''}"><a href="{:url('risk/suspension')}"><i class="fa fa-circle-o"></i> 停牌复牌列表</a></li>
                    </ul>
                </li>

                <li class="treeview {$controller=='Order'?'active':''}">
                    <a href="#">
                        <i class="fa  fa-book"></i> <span>订单管理</span>
                        <span class="pull-right-container">
                            <i class="fa fa-angle-left pull-right"></i>
                        </span>
                    </a>
                    <ul class="treeview-menu">
                        <li class="{$action=='position'?'active':''}"><a href="{:url('order/position')}"><i class="fa fa-circle-o"></i> 持仓列表</a></li>
                        <li class="{$action=='order'?'active':''}"><a href="{:url('order/order')}"><i class="fa fa-circle-o"></i> 委托列表</a></li>
                        <li class="{$action=='traded'?'active':''}"><a href="{:url('order/traded')}"><i class="fa fa-circle-o"></i> 成交明细</a></li>
                        <li class="{$action=='close_position'?'active':''}"><a href="{:url('order/close_position')}"><i class="fa fa-circle-o"></i> 平仓结算</a></li>
                        <li class="{$action=='forced_sell_log'?'active':''}"><a href="{:url('order/forced_sell_log')}"><i class="fa fa-circle-o"></i> 平仓日志</a></li>
                        <li class="{$action=='condition'?'active':''}"><a href="{:url('order/condition')}"><i class="fa fa-circle-o"></i> 条件单列表</a></li>
                    </ul>
                </li>

                <li class="treeview {$controller=='User'?'active':''}">
                    <a href="#">
                        <i class="fa fa-user"></i> <span>用户管理</span>
                        <span class="pull-right-container">
                            <i class="fa fa-angle-left pull-right"></i>
                        </span>
                    </a>
                    <ul class="treeview-menu">
                        <li class="{$action=='index'?'active':''}"><a href="{:url('user/index')}"><i class="fa fa-circle-o"></i> 用户列表</a></li>
                        <li class="{$action=='add_user'?'active':''}"><a href="{:url('user/add_user')}"><i class="fa fa-circle-o"></i> 添加用户</a></li>
                        <li class="{$action=='recharge_log'?'active':''}"><a href="{:url('user/recharge_log')}"><i class="fa fa-circle-o"></i> 充值记录</a></li>
                        <li class="{$action=='withdraw_log'?'active':''}"><a href="{:url('user/withdraw_log')}"><i class="fa fa-circle-o"></i> 提现申请</a></li>
                        <li class="{$action=='wallet_log'?'active':''}"><a href="{:url('user/wallet_log')}"><i class="fa fa-circle-o"></i> 账户资金流水</a></li>
                        <li class="{$action=='strategy_log'?'active':''}"><a href="{:url('user/strategy_log')}"><i class="fa fa-circle-o"></i> 策略金流水</a></li>
                        <li class="{$action=='cash_coupon_log'?'active':''}"><a href="{:url('user/cash_coupon_log')}"><i class="fa fa-circle-o"></i> 代金券资金流水</a></li>
                        <li class="{$action=='frozen_log'?'active':''}"><a href="{:url('user/frozen_log')}"><i class="fa fa-circle-o"></i> 冻结策略金流水</a></li>
                        <li class="{$action=='yuebao_log'?'active':''}"><a href="{:url('user/yuebao_log')}"><i class="fa fa-circle-o"></i> 收益宝收益明细</a></li>
                    </ul>
                </li>

                <li class="treeview {$controller=='Agent'?'active':''}">
                    <a href="#">
                        <i class="fa fa-user"></i> <span>代理商管理</span>
                        <span class="pull-right-container">
                            <i class="fa fa-angle-left pull-right"></i>
                        </span>
                    </a>
                    <ul class="treeview-menu">
                        <li class="{$action=='index'?'active':''}"><a href="{:url('agent/index')}"><i class="fa fa-circle-o"></i> 代理商列表</a></li>
                        <li class="{$action=='account_log'?'active':''}"><a href="{:url('agent/account_log')}"><i class="fa fa-circle-o"></i> 资金明细</a></li>
                        <li class="{$action=='withdraw_log'?'active':''}"><a href="{:url('agent/withdraw_log')}"><i class="fa fa-circle-o"></i> 提现申请</a></li>
                    </ul>
                </li>

                <li class="treeview {$controller=='Broker'?'active':''}">
                    <a href="#">
                        <i class="fa fa-user"></i> <span>经纪人管理</span>
                        <span class="pull-right-container">
                            <i class="fa fa-angle-left pull-right"></i>
                        </span>
                    </a>
                    <ul class="treeview-menu">
                        <li class="{$action=='index'?'active':''}"><a href="{:url('broker/index')}"><i class="fa fa-circle-o"></i> 经纪人列表</a></li>
                        <li class="{$action=='account_log'?'active':''}"><a href="{:url('broker/account_log')}"><i class="fa fa-circle-o"></i> 资金明细</a></li>
                        <li class="{$action=='withdraw_log'?'active':''}"><a href="{:url('broker/withdraw_log')}"><i class="fa fa-circle-o"></i> 提现申请</a></li>
                        <li class="{$action=='strategy_log'?'active':''}"><a href="{:url('user/strategy_log')}"><i class="fa fa-circle-o"></i> 策略金流水</a></li>
                    </ul>
                </li>

                <li class="treeview {$controller=='Income'?'active':''}">
                    <a href="#">
                        <i class="fa fa-money"></i> <span>佣金管理</span>
                        <span class="pull-right-container">
                            <i class="fa fa-angle-left pull-right"></i>
                        </span>
                    </a>
                    <ul class="treeview-menu">
                        <li class="{$action=='index'?'active':''}"><a href="{:url('income/index')}"><i class="fa fa-circle-o"></i> 管理费返佣</a></li>
                    </ul>
                </li>

                <li class="treeview {$controller=='Settings'?'active':''}">
                    <a href="#">
                        <i class="fa fa-cog"></i> <span>系统设置</span>
                        <span class="pull-right-container">
                            <i class="fa fa-angle-left pull-right"></i>
                        </span>
                    </a>
                    <ul class="treeview-menu">
                        <li class="{$action=='config'?'active':''}"><a href="{:url('settings/config')}"><i class="fa fa-circle-o"></i>基础设置</a></li>
                        <li class="{$action=='trading_time'?'active':''}"><a href="{:url('settings/trading_time')}"><i class="fa fa-circle-o"></i> 交易时间设置</a></li>
                        <li class="{$action=='non_trading_date'?'active':''}"><a href="{:url('settings/non_trading_date')}"><i class="fa fa-circle-o"></i> 非交易日管理</a></li>
                        <li class="{$action=='trading_fee'?'active':''}"><a href="{:url('settings/trading_fee')}"><i class="fa fa-circle-o"></i> 交易费用</a></li>
                        <li class="{$action=='yuebao_set'?'active':''}"><a href="{:url('settings/yuebao_set')}"><i class="fa fa-circle-o"></i> 收益宝配置</a></li>
                        <li class="{$action=='buy_limit_rate'?'active':''}"><a href="{:url('settings/buy_limit_rate')}"><i class="fa fa-circle-o"></i>涨跌幅禁买线</a></li>
                        <li class="{$action=='payment_way'?'active':''}"><a href="{:url('settings/payment_way')}"><i class="fa fa-circle-o"></i> 支付方式</a></li>
                        <!--li class="{$action=='qrcode_set'?'active':''}"><a href="{:url('settings/qrcode_set')}"><i class="fa fa-circle-o"></i>二维码设置</a></li-->
                        <li class="{$action=='cash_coupon_set'?'active':''}"><a href="{:url('settings/cash_coupon_set')}"><i class="fa fa-circle-o"></i>代金券设置</a></li>
                        <li class="{$action=='app_config'?'active':''}"><a href="{:url('settings/app_config')}"><i class="fa fa-circle-o"></i>APP设置</a></li>
                    </ul>
                </li>

                <li class="treeview {$controller=='Passport'?'active':''}">
                    <a href="#">
                        <i class="fa fa-user"></i> <span>管理员</span>
                        <span class="pull-right-container">
                            <i class="fa fa-angle-left pull-right"></i>
                        </span>
                    </a>
                    <ul class="treeview-menu">
                        <li class="{$action=='modify_password'?'active':''}"><a href="{:url('passport/modify_password')}"><i class="fa fa-circle-o"></i> 修改密码</a></li>
                    </ul>
                </li>
            </ul>
        </section>
    </aside>

    <!--  内容主体 -->
    {block name="main"}{/block}
</div>

<!-- Bootstrap 3.3.7 -->
<script src="__ADMIN_LTE__/components/bootstrap/js/bootstrap.min.js"></script>
<!-- FastClick -->
<script src="__ADMIN_LTE__/components/fastclick/lib/fastclick.js"></script>
<!-- AdminLTE App -->
<script src="__ADMIN_LTE__/dist/js/adminlte.min.js"></script>

<!-- 页面自定义JS内容部分 -->
{block name="js"}{/block}
<script type="text/javascript">
    function signOut() {
        $.post("{:url('stock/auth/signOut')}", function(data){
            if(data.code == 1){
                layer.msg(data.msg, {icon:1, time:1500, shade:.3, shadeClose:true}, function(){
                    window.location.href = "{:url('index/index')}";
                });
            } else {
                layer.msg(data.msg, {icon:2, time:1500, shade:.3, shadeClose:true});
            }
        });
    }

    var wsUri = "wss://{$hostip}/wss";
    var websocket = null;
    var wsLock = false;
    var heartCheck = {
        timeout: 3000,
        intervalObj: null,
        data: {"Key": "Heartbeat","Token": "{$_SESSION['think']['token']}"},
        reset: function () {
            this.intervalObj && clearInterval(this.intervalObj);
            heartCheck.start();
        },
        start: function () {
            console.log('充值、提现服务器连接成功');
            this.intervalObj && clearInterval(this.intervalObj);
            this.intervalObj = setInterval(function () {
                websocket.send(JSON.stringify(heartCheck.data));
            }, heartCheck.timeout)
        },
        stop: function () {
            clearInterval(this.intervalObj);
        }
    };

    function createWebsocket() {
        websocket = new WebSocket(wsUri);
        websocket.onopen = function(evt) {
            onOpen(evt)
        };
        websocket.onclose = function(evt) {
            onClose(evt)
        };
        websocket.onmessage = function(evt) {
            onMessage(evt)
        };
        websocket.onerror = function(evt) {
            onError(evt)
        };
    }
    createWebsocket();
    function onOpen(evt) {
        heartCheck.start();
        var token = "{$_SESSION['think']['token']}";
        var data={
            "Key": "Heartbeat",
            "Token": token
        };
        var message=JSON.stringify(data);
        setInterval(doSend(message),1000);
    }

    function onMessage(evt) {
        var data=JSON.parse(evt.data);
        var str = data.data;
        // 提现申请提醒
        if(str.indexOf('withdrawRemind') != -1){
            // 提现提醒弹窗
            checkDialog(1);
            removeRemind('withdrawRemind');
        }
        if(str.indexOf('rechargeRemind') != -1){
            // 提现提醒弹窗
            checkDialog(2);
            removeRemind('rechargeRemind');
        }
    }

    function onClose(evt) {
        heartCheck.stop();
        restartWebSocket();
    }

    function onError(evt) {
        conosole.log('充值提现服务器连接失败');
        heartCheck.stop();
        restartWebSocket();
    }

    // 重连
    function restartWebSocket() {
        if (wsLock == true) return false;
        wsLock == true;

        setTimeout(function () {
            createWebsocket();
            wsLock == false;
        }, 3000);
    }

    function doSend(message) {
        websocket.send(message);
    }

    function checkDialog(v) {
        $.notifySetup({sound: '__DASH__/lib/notify/audio/notify.mp3'});
        if(v == 1){
            $('<p>您有新的提现申请，请及时处理！</p>').notify();
        }
        if(v == 2){
            $('<p>您有新的充值记录，请及时查看！</p>').notify();
        }
    }
    function removeRemind(remind) {
        $.post("{:url('stock/userWithdraw/removeFlag')}", {remind: remind}, function (data) {
        });
    }
    $(document).ready(function () {
        var hover_index = 0;
        $("table.table td").hover(function () {
            hover_index = $(this).parent().find('td').index(this);
            $("table.table tr").find("td:eq(" + hover_index + ")").addClass("hewenqi");
            $(this).addClass("hewenqi");
        }, function () {
            $("table.table tr").find("td:eq(" + hover_index + ")").removeClass("hewenqi");
            $(this).removeClass("hewenqi");
        });

        $("table.table tbody tr").hover(function () {
            $(this).addClass("hewenqi");
        }, function () {
            $(this).removeClass("hewenqi");
        });
    });
</script>
</body>
</html>